<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Visor LiDAR Inmersivo</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/potree@1.8.2/build/potree/potree.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #potree_render_area {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 1000;
            background: rgba(0,0,0,0.9);
            padding: 30px;
            border-radius: 15px;
            min-width: 300px;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 13px;
            z-index: 100;
            display: none;
        }
        #gyroButton {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: none;
        }
        #gyroButton.active {
            background: rgba(244, 67, 54, 0.9);
        }
        .potree_container {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>üèõÔ∏è Cargando Espacio LiDAR</h2>
        <p style="margin-top: 15px; font-size: 14px;">Esto puede tardar 1-2 minutos...</p>
    </div>
    
    <button id="gyroButton">Activar Navegaci√≥n</button>
    
    <div id="info">
        üì± Mueve el celular para mirar alrededor<br>
        üö∂ Camina f√≠sicamente para moverte
    </div>

    <div class="potree_container">
        <div id="potree_render_area"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/potree@1.8.2/build/potree/potree.js"></script>
    
    <script>
        let viewer;
        let gyroEnabled = false;
        let baseYaw = 0, basePitch = 0;
        let currentYaw = 0, currentPitch = 0;
        
        const modelURL = "https://pub-1e69cc75cdd542d999c8606439faeee6.r2.dev/salida_potree/chunks/metadata.json";

        function init() {
            viewer = new Potree.Viewer(document.getElementById("potree_render_area"));
            
            viewer.setEDLEnabled(true);
            viewer.setFOV(75);
            viewer.setPointBudget(3_000_000);
            viewer.setMinNodeSize(0);
            viewer.setBackground("gradient");
            
            // Configurar controles
            viewer.setControls(viewer.orbitControls);
            viewer.orbitControls.enabled = false; // Desactivar controles por defecto
            
            loadPointCloud();
            setupGyroButton();
        }

        function loadPointCloud() {
            Potree.loadPointCloud(modelURL, "Espacio", (e) => {
                if (e.type === "loading_failed") {
                    document.getElementById('loading').innerHTML = 
                        '<h2>‚ùå Error al cargar</h2><p>No se pudo acceder al modelo</p>';
                    return;
                }
                
                let pointcloud = e.pointcloud;
                let material = pointcloud.material;
                
                viewer.scene.addPointCloud(pointcloud);
                
                // Configurar material
                material.pointColorType = Potree.PointColorType.RGB;
                material.size = 1.0;
                material.pointSizeType = Potree.PointSizeType.ADAPTIVE;
                material.shape = Potree.PointShape.SQUARE;
                
                // Ajustar vista inicial
                viewer.fitToScreen();
                
                // Posicionar c√°mara a altura de persona
                setTimeout(() => {
                    const boundingBox = pointcloud.boundingBox;
                    const center = boundingBox.getCenter(new THREE.Vector3());
                    const minY = boundingBox.min.y;
                    
                    viewer.scene.view.position.set(
                        center.x,
                        minY + 1.7, // 1.7m sobre el suelo
                        center.z
                    );
                    
                    viewer.scene.view.lookAt(
                        center.x,
                        minY + 1.7,
                        center.z - 5
                    );
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('gyroButton').style.display = 'block';
                    document.getElementById('info').style.display = 'block';
                }, 1000);
            });
        }

        function setupGyroButton() {
            const btn = document.getElementById('gyroButton');
            btn.addEventListener('click', () => {
                if (!gyroEnabled) {
                    requestGyroPermission();
                } else {
                    disableGyro();
                }
            });
        }

        function requestGyroPermission() {
            if (typeof DeviceOrientationEvent !== 'undefined' && 
                typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response === 'granted') {
                            enableGyro();
                        }
                    })
                    .catch(console.error);
            } else {
                enableGyro();
            }
        }

        function enableGyro() {
            gyroEnabled = true;
            window.addEventListener('deviceorientation', handleOrientation);
            
            const btn = document.getElementById('gyroButton');
            btn.textContent = 'Desactivar Navegaci√≥n';
            btn.classList.add('active');
            
            // Desactivar controles de rat√≥n/touch
            viewer.orbitControls.enabled = false;
        }

        function disableGyro() {
            gyroEnabled = false;
            window.removeEventListener('deviceorientation', handleOrientation);
            
            const btn = document.getElementById('gyroButton');
            btn.textContent = 'Activar Navegaci√≥n';
            btn.classList.remove('active');
            
            viewer.orbitControls.enabled = true;
        }

        function handleOrientation(event) {
            if (!gyroEnabled || !viewer || !viewer.scene) return;
            
            const alpha = event.alpha || 0; // Z axis (compass)
            const beta = event.beta || 0;   // X axis (front-back tilt)
            const gamma = event.gamma || 0; // Y axis (left-right tilt)
            
            // Convertir a radianes
            const yaw = THREE.MathUtils.degToRad(alpha);
            const pitch = THREE.MathUtils.degToRad(beta - 90);
            
            // Limitar pitch
            const clampedPitch = Math.max(-Math.PI/2 + 0.1, Math.min(Math.PI/2 - 0.1, pitch));
            
            // Aplicar rotaci√≥n a la c√°mara
            const camera = viewer.scene.getActiveCamera();
            const position = viewer.scene.view.position.clone();
            
            // Calcular direcci√≥n de vista
            const lookDistance = 5;
            const lookAt = new THREE.Vector3(
                position.x + Math.sin(yaw) * Math.cos(clampedPitch) * lookDistance,
                position.y + Math.sin(clampedPitch) * lookDistance,
                position.z + Math.cos(yaw) * Math.cos(clampedPitch) * lookDistance
            );
            
            viewer.scene.view.lookAt(lookAt);
        }

        // Iniciar cuando cargue la p√°gina
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
